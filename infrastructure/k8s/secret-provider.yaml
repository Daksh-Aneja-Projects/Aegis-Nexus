apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: aegis-pqc-secrets
  namespace: aegis-nexus
spec:
  # HashiCorp Vault provider
  provider: vault
  
  parameters:
    # Vault configuration
    vaultAddress: "https://vault.aegis-nexus.svc:8200"
    roleName: "aegis-api"
    
    # Secret objects to fetch from Vault
    objects: |
      - objectName: "pqc-private-key"
        secretPath: "secret/data/aegis/pqc"
        secretKey: "private_key"
      - objectName: "pqc-public-key"
        secretPath: "secret/data/aegis/pqc"
        secretKey: "public_key"
      - objectName: "pqc-algorithm-oid"
        secretPath: "secret/data/aegis/pqc"
        secretKey: "algorithm_oid"
    
  # Create Kubernetes Secret from Vault data (optional sync)
  secretObjects:
    - data:
        - key: pqc-private-key
          objectName: pqc-private-key
        - key: pqc-public-key
          objectName: pqc-public-key
        - key: pqc-algorithm-oid
          objectName: pqc-algorithm-oid
      secretName: aegis-pqc-synced
      type: Opaque

---
# ServiceAccount with Vault authentication binding
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aegis-api
  namespace: aegis-nexus
  annotations:
    # Vault auth role binding
    vault.hashicorp.com/role: "aegis-api"

---
# ClusterSecretStore for cross-namespace secret access (if needed)
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aegis-vault-backend
spec:
  provider:
    vault:
      server: "https://vault.aegis-nexus.svc:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "aegis-api"
          serviceAccountRef:
            name: aegis-api
            namespace: aegis-nexus
